<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Latin Chaos</title>
  <link rel="stylesheet" href="/estilos/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="body-admin">
  <div class="admin-container">
    <h1 class="admin-title">ğŸ”’ Panel de AdministraciÃ³n</h1>

    <!-- BotÃ³n login/logout -->
    <button id="loginBtn" class="btn-auth">Iniciar sesiÃ³n con Google</button>
    <button id="logoutBtn" class="btn-auth" style="display:none;">Cerrar sesiÃ³n</button>

    <!-- Si es admin -->
    <div id="adminContent" style="display:none;">
      <p>âœ… EstÃ¡s autenticado como administrador.</p>

      <!-- Subida manual -->
      <hr />
      <h2 class="admin-subtitle">ğŸ“¤ Subir resultado</h2>
      <form id="formularioPartida" class="form-partida">
        <label for="modo">Modo:</label>
        <select id="modo" required>
          <option value="FFA">FFA</option>
          <option value="2v2">2v2</option>
          <option value="1v1">1v1</option>
        </select>

        <label for="jugadores">Jugadores (separados por coma):</label>
        <input type="text" id="jugadores" placeholder="Ej: jugador1, jugador2, ..." required />

        <label for="ganador">Ganador:</label>
        <input type="text" id="ganador" required />

        <button type="submit" class="btn-subir">Subir resultado</button>
      </form>

      <!-- Filtros -->
      <div class="filtros">
        <input type="text" id="filtroJugador" placeholder="Filtrar por jugador" class="input-filtro">
        <select id="filtroModo" class="select-filtro">
          <option value="">Todos los modos</option>
          <option value="FFA">FFA</option>
          <option value="2v2">2v2</option>
          <option value="1v1">1v1</option>
        </select>
      </div>

      <!-- Resultados -->
      <div id="resultadosContainer" class="tabla-container"></div>
    </div>

    <!-- Si no tiene permisos -->
    <div id="notAllowed" style="display:none; color:red;">
      âŒ Tu cuenta no tiene permisos de administrador.
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://uvggwcpwgnvaczczyyyh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2Z2d3Y3B3Z252YWN6Y3p5eXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTA5NDgsImV4cCI6MjA2OTU4Njk0OH0.XjgRRGv4c0Bu8t5Kj3w8zjR5-uAaI2E1TJJPaDRZsRM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function login() {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.href
        }
      });
      if (error) console.error('Error al iniciar sesiÃ³n:', error.message);
    }

    async function logout() {
      const { error } = await supabase.auth.signOut();
      if (error) console.error('Error al cerrar sesiÃ³n:', error.message);
      else location.reload();
    }

    async function checkSession() {
      let { data } = await supabase.auth.getSession();
      let session = data?.session;

      // Retry si no hay sesiÃ³n todavÃ­a
      if (!session) {
        await new Promise(res => setTimeout(res, 500));
        ({ data } = await supabase.auth.getSession());
        session = data?.session;
      }

      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (!session) {
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        return;
      }

      const userEmail = session.user.email;
      const { data: admin, error: adminError } = await supabase
        .from("admins")
        .select("email")
        .eq("email", userEmail)
        .eq("is_active", true)
        .maybeSingle();

      if (adminError) {
        console.error('Error al verificar permisos:', adminError.message);
        return;
      }

      if (!admin) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";
        document.getElementById("notAllowed").style.display = "block";
        return;
      }

      loginBtn.style.display = "none";
      logoutBtn.style.display = "block";
      document.getElementById("adminContent").style.display = "block";
      cargarPartidas();
    }

    async function cargarPartidas() {
      const { data: partidas, error } = await supabase
        .from("replays")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Error al cargar partidas:", error.message);
        return;
      }

      mostrarPartidas(partidas);
    }

    function mostrarPartidas(lista) {
      const filtroJugador = document.getElementById("filtroJugador").value.toLowerCase();
      const filtroModo = document.getElementById("filtroModo").value;
      const contenedor = document.getElementById("resultadosContainer");
      contenedor.innerHTML = "";

      const partidasFiltradas = lista.filter(p => {
        const coincideJugador = p.players.some(j => j.toLowerCase().includes(filtroJugador));
        const coincideModo = filtroModo === "" || p.mode === filtroModo;
        return coincideJugador && coincideModo;
      });

      partidasFiltradas.forEach(p => {
        const card = document.createElement("div");
        card.className = "partida-card";
        card.innerHTML = `
          <h3>ğŸ•¹ï¸ ${p.mode}</h3>
          <p><strong>Jugadores:</strong> ${p.players.join(", ")}</p>
          <p><strong>Ganador:</strong> ${p.winner}</p>
          <p><strong>Fecha:</strong> ${new Date(p.created_at).toLocaleString()}</p>
          <button onclick="eliminarPartida('${p.id}')" class="btn-eliminar">ğŸ—‘ï¸ Eliminar</button>
        `;
        contenedor.appendChild(card);
      });
    }

    async function eliminarPartida(id) {
      if (!confirm("Â¿Seguro que quieres eliminar esta partida?")) return;
      const { error } = await supabase.from("replays").delete().eq("id", id);
      if (error) {
        console.error("Error al eliminar:", error.message);
        return;
      }
      cargarPartidas();
    }

    document.getElementById("loginBtn").addEventListener("click", login);
    document.getElementById("logoutBtn").addEventListener("click", logout);
    document.getElementById("filtroJugador").addEventListener("input", cargarPartidas);
    document.getElementById("filtroModo").addEventListener("change", cargarPartidas);

    document.getElementById("formularioPartida").addEventListener("submit", async (e) => {
      e.preventDefault();

      const modo = document.getElementById("modo").value;
      const jugadoresRaw = document.getElementById("jugadores").value;
      const ganador = document.getElementById("ganador").value;
      const jugadores = jugadoresRaw.split(",").map(j => j.trim()).filter(Boolean);

      if (jugadores.length < 2) {
        alert("Debes ingresar al menos 2 jugadores.");
        return;
      }

      const { error } = await supabase.from("replays").insert([
        {
          mode: modo,
          players: jugadores,
          winner: ganador
        }
      ]);

      if (error) {
        console.error("Error al subir partida:", error.message);
        alert("Error al subir partida.");
      } else {
        alert("Partida subida correctamente.");
        document.getElementById("formularioPartida").reset();
        cargarPartidas();
      }
    });

    // Escuchar cambios de sesiÃ³n
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        checkSession();
      }
    });

    checkSession();
  </script>
</body>
</html>
